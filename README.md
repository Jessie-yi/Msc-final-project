# Msc-final-project-HES Interactive Dashboard (Streamlit + Plotly)

A multi‑page Streamlit application for exploring NHS Hospital Episode Statistics (HES) across financial years (Apr–Mar 2015-2024). It provides code‑level drill‑downs, trends, treemaps, heatmaps, slopegraphs, and a finder view. Deep‑linking preserves state in the URL so views can be shared and reproduced.

## Features

- **Finder**: search and open code‑level views with current filters.
- **Bar**: Top‑N / Show‑All, sort by totals, stacked and 100% stacked.
- **Trends (Line / Heatmap)**: multi‑year lines and composition heatmaps; index baseline (2019/20=100) and YoY deltas.
- **Treemap**: hierarchical composition by Group → Gender → 3-char Code/4-char Code with continuous/categorical color modes.
- **Slopegraph**: code‑level small multiples for index / shares.
- **Explore**: compact “all‑in‑one” explorer for fast screening.
- **Deep‑linking**: `router.py` encodes filters to query params and restores state across pages.
- **Downloads**: figures can be saved as PNG via the Plotly toolbar (or `kaleido` when enabled).

## Data

- **Source**: NHS HES workbooks (financial years, Apr–Mar).  
- **Prepared CSVs** (expected in project root unless configured otherwise):
  - `hes_yearly_totals_2015_2024.csv` (macro totals by year)
  - `codes_multi_year.csv` (Code3/Code4 multi‑year metrics)
  - `attribute_dictionary.csv` (labels, groupings, dictionaries)
- **Builder**: if source workbooks are available, run `data_builder.py` to generate the CSVs. Header variations (2015–22 vs 2023/24) and type coercions are handled inside the builder.

> Baseline and metrics: Index uses **2019/20=100**; YoY = `current / previous - 1`; wait‑time/LOS in days.

## Project Structure

```
app.py                      # Streamlit entry
router.py                   # URL state read/write, deep-link helpers
common_header.py            # shared layout/header utilities
colors_tokens.py            # color tokens and categorical maps

data_io.py                  # unified load/clean/filter/aggregate
treemap_io.py               # treemap-specific data preparation
data_builder.py             # build CSVs from NHS workbooks

01_Finder.py                # page: Finder
03_Trends.py                # page: Trends (lines/heatmap)
04_Heatmap.py               # page: Heatmap (composition)
05_Slopegraph.py            # page: Slopegraph
06_Explore.py               # page: Explore (compact)
bar_tab.py                  # Bar view controls + render
treemap_tab.py              # Treemap controls + render
```

## Quickstart

### 1) Environment

```bash
# Python 3.10+ (3.11 recommended)
python -m venv .venv && source .venv/bin/activate   # (Windows: .venv\Scripts\activate)
python -m pip install --upgrade pip

# Core deps
pip install streamlit plotly pandas numpy openpyxl kaleido

# Optional (docs/QA)
pip install pdoc black isort flake8 mypy
```

### 2) Data

- Place the prepared CSVs in the repository root (see **Data**).  
- Or, if you have the NHS Excel workbooks, configure input paths inside `data_builder.py` and run:
  ```bash
  python data_builder.py
  ```

### 3) Run

```bash
streamlit run app.py
```

Open the URL shown in the terminal. Use the page links (Finder/Bar/Trends/Heatmap/Treemap/Slopegraph/Explore) at the top/right to navigate.

### 4) Configuration

| Item                    | Where to change                                  | Default / Status                                                        | Notes                                                                                 |
|-------------------------|---------------------------------------------------|-------------------------------------------------------------------------|---------------------------------------------------------------------------------------|
| **Data sources**        | Generated by scripts (`data_builder.py`, `build_codes_multi_year.py`) | `hes_yearly_totals_2015_2024.csv`; `codes_multi_year.csv`               | Run the scripts above to regenerate if missing.                                       |
| **Colors & Orders**     | `colors_tokens.py`                                | `GENDER_ORDER` / `ADMISSION_ORDER` / `COLOR_DISCRETE_MAP`               | Changes take effect site-wide (Trends/Heatmap/Treemap/Bar).                           |
| **Layout / Theme**      | Per page via `fig.update_layout(...)`            | `template="plotly_white"`, horizontal legend                           | e.g., percentage axis `tickformat=".0%"`; LOS axis `ticksuffix=" d"`.                 |
| **Figure exports**      | Plotly toolbar; optional `kaleido`               | PNG via camera icon; one-click download buttons when `kaleido` installed | Install: `pip install -U kaleido`.                                                    |                                          | Share via **Export PNG/CSV** or the **Unlisted demo video** (see Supplementary).     |


### Regenerate data (for reproducibility)
```bash
# Annual Summary (Trends/Heatmap Usage)
python data_builder.py

# Code × Annual Table（Bar/Treemap Usage）
python build_codes_multi_year.py

## Reproducibility

- Pin Python and packages with `requirements.txt` / `environment.yml`.  
- Tag a release before submission (e.g., `v1.0.0`); reference the tag in the dissertation/appendix.
- Optional: generate HTML API docs from docstrings (see **Contributing → Commenting Your Code**).

## Citing

If you use this dashboard in academic work, please cite the project and the NHS HES data source. Provide a stable tag/DOI (e.g., GitHub release).

## License

Choose a license (e.g., MIT) and place it in `LICENSE`. Update this section accordingly.
